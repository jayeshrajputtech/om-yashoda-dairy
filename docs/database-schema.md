# Database Schema - OM Yashoda Dairy

Complete database schema for Firestore collections.

---

## Collections Overview

```
firestore
├── products/          # Product catalog
├── users/             # User profiles
└── orders/            # Customer orders
```

---

## 1. Products Collection

**Collection:** `products`  
**Document ID:** Product slug (e.g., `buffalo-ghee`, `cow-milk`)

### Schema

```javascript
{
  // Identifiers
  id: string,                    // Product slug (same as document ID)
  
  // Names (Multilingual)
  nameEnglish: string,           // English name
  nameHindi: string,             // Hindi name (Devanagari)
  nameMarathi: string,           // Marathi name (Devanagari)
  
  // Pricing & Units
  price: number,                 // Price in INR (₹)
  unit: string,                  // Unit (e.g., "1kg", "500ml", "1L")
  
  // Classification
  category: string,              // "premium" | "regular" | "special"
  
  // Availability
  inStock: boolean,              // true = available, false = out of stock
  featured: boolean,             // Show on homepage
  
  // Media
  image: string,                 // Image path (e.g., "/images/products/buffalo-ghee.jpg")
  
  // Timestamps
  createdAt: timestamp,          // When product was added
  updatedAt: timestamp           // Last update time
}
```

### Example Document

```javascript
// Document ID: buffalo-ghee
{
  id: "buffalo-ghee",
  nameEnglish: "Buffalo Ghee",
  nameHindi: "भैंस का घी",
  nameMarathi: "म्हशीचे तूप",
  price: 800,
  unit: "1kg",
  category: "premium",
  inStock: true,
  featured: true,
  image: "/images/products/buffalo-ghee.jpg",
  createdAt: Timestamp(2026-02-13 00:00:00),
  updatedAt: Timestamp(2026-02-13 00:00:00)
}
```

### Indexes

```
Collection: products
- inStock (ASC) + category (ASC) + nameEnglish (ASC)
- featured (DESC) + inStock (ASC)
```

---

## 2. Users Collection

**Collection:** `users`  
**Document ID:** Firebase Auth UID

### Schema

```javascript
{
  // Firebase Auth
  uid: string,                   // Firebase Auth user ID (same as document ID)
  email: string,                 // User email
  displayName: string,           // Full name
  
  // Contact
  phone: string | null,          // Phone number (with country code)
  
  // Address (from last order)
  address: string | null,        // Delivery address
  landmark: string | null,       // Landmark
  
  // Timestamps
  createdAt: timestamp,          // Account creation
  updatedAt: timestamp           // Last profile update
}
```

### Example Document

```javascript
// Document ID: abc123xyz (Firebase UID)
{
  uid: "abc123xyz",
  email: "customer@example.com",
  displayName: "Rajesh Kumar",
  phone: "+919876543210",
  address: "123 Main Street, Kalyan West",
  landmark: "Near Railway Station",
  createdAt: Timestamp(2026-02-13 10:00:00),
  updatedAt: Timestamp(2026-02-13 10:00:00)
}
```

### Indexes

```
Collection: users
- email (ASC)
```

---

## 3. Orders Collection

**Collection:** `orders`  
**Document ID:** Auto-generated by Firestore

### Schema

```javascript
{
  // Order Identification
  orderId: string,               // Human-readable ID (e.g., "ORD-20260213-001")
  userId: string,                // Firebase Auth UID (references users collection)
  
  // Customer Details (snapshot at order time)
  customer: {
    name: string,                // Customer name
    phone: string,               // Phone number
    email: string | null,        // Email (optional)
    address: string,             // Delivery address
    landmark: string | null      // Landmark (optional)
  },
  
  // Order Items
  items: [
    {
      productId: string,         // Product ID (references products collection)
      productName: string,       // Product name (snapshot)
      productNameHindi: string,  // Hindi name (snapshot)
      quantity: number,          // Quantity ordered
      price: number,             // Price per unit (snapshot)
      unit: string,              // Unit (snapshot)
      subtotal: number           // quantity × price
    }
  ],
  
  // Pricing
  subtotal: number,              // Sum of all item subtotals
  deliveryCharge: number,        // Delivery fee (0 for now)
  total: number,                 // subtotal + deliveryCharge
  
  // Order Details
  status: string,                // "pending" | "confirmed" | "delivered" | "cancelled"
  deliverySlot: string,          // "Morning (7 AM - 10 AM)" etc.
  paymentMethod: string,         // "Cash on Delivery"
  specialInstructions: string | null, // Customer notes
  
  // Timestamps
  createdAt: timestamp,          // Order placed time
  updatedAt: timestamp           // Last status update
}
```

### Example Document

```javascript
// Document ID: auto-generated
{
  orderId: "ORD-20260213-001",
  userId: "abc123xyz",
  customer: {
    name: "Rajesh Kumar",
    phone: "+919876543210",
    email: "customer@example.com",
    address: "123 Main Street, Kalyan West",
    landmark: "Near Railway Station"
  },
  items: [
    {
      productId: "buffalo-ghee",
      productName: "Buffalo Ghee",
      productNameHindi: "भैंस का घी",
      quantity: 2,
      price: 800,
      unit: "1kg",
      subtotal: 1600
    },
    {
      productId: "cow-milk",
      productName: "Fresh Cow Milk",
      productNameHindi: "ताज़ा गाय का दूध",
      quantity: 1,
      price: 60,
      unit: "1L",
      subtotal: 60
    }
  ],
  subtotal: 1660,
  deliveryCharge: 0,
  total: 1660,
  status: "pending",
  deliverySlot: "Morning (7 AM - 10 AM)",
  paymentMethod: "Cash on Delivery",
  specialInstructions: "Please call before delivery",
  createdAt: Timestamp(2026-02-13 10:30:00),
  updatedAt: Timestamp(2026-02-13 10:30:00)
}
```

### Indexes

```
Collection: orders
- userId (ASC) + createdAt (DESC)
- status (ASC) + createdAt (DESC)
- createdAt (DESC)
```

---

## Security Rules

### Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Products - Read-only for all (via API)
    match /products/{productId} {
      allow read: if true;
      allow write: if false; // Only via admin SDK
    }
    
    // Users - Users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Orders - Users can create and read their own orders
    match /orders/{orderId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.userId;
      allow update: if false; // Only via admin SDK
      allow delete: if false; // No deletions
    }
  }
}
```

---

## Data Migration

### Initial Product Sync

```bash
# Run sync script to populate products collection
node scripts/sync-products.js
```

### Automated Sync

Products are automatically synced when `data/products.json` is updated:
1. Edit `data/products.json`
2. Commit and push to GitHub
3. GitHub Action runs `sync-products.js`
4. Products updated in Firestore

---

## Backup Strategy

### Firestore Automatic Backups

Enable in Firebase Console:
1. Go to Firestore → Backups
2. Enable automatic daily backups
3. Retention: 7 days

### Manual Export

```bash
# Export all collections
gcloud firestore export gs://[BUCKET_NAME]/[EXPORT_FOLDER]

# Import from backup
gcloud firestore import gs://[BUCKET_NAME]/[EXPORT_FOLDER]
```

---

## Query Examples

### Get All Active Products

```javascript
const products = await db.collection('products')
  .where('inStock', '==', true)
  .orderBy('category')
  .orderBy('nameEnglish')
  .get();
```

### Get Featured Products

```javascript
const featured = await db.collection('products')
  .where('featured', '==', true)
  .where('inStock', '==', true)
  .limit(6)
  .get();
```

### Get User Orders

```javascript
const orders = await db.collection('orders')
  .where('userId', '==', userId)
  .orderBy('createdAt', 'desc')
  .limit(10)
  .get();
```

### Get Pending Orders

```javascript
const pending = await db.collection('orders')
  .where('status', '==', 'pending')
  .orderBy('createdAt', 'desc')
  .get();
```

---

## Storage Estimates

### Products Collection
- Documents: ~12-50
- Size per document: ~500 bytes
- Total: ~25 KB

### Users Collection
- Documents: ~100-1000 (estimated)
- Size per document: ~300 bytes
- Total: ~300 KB

### Orders Collection
- Documents: ~1000-10000/year
- Size per document: ~2 KB
- Total: ~20 MB/year

**Total Database Size (Year 1):** ~20 MB  
**Firestore Free Tier:** 1 GB storage ✅

---

## Cost Analysis

### Firestore Free Tier
- **Storage:** 1 GB (enough for years)
- **Reads:** 50,000/day (plenty for small shop)
- **Writes:** 20,000/day (more than enough)
- **Deletes:** 20,000/day

### Estimated Usage
- **Product reads:** ~100-500/day
- **Order writes:** ~10-50/day
- **User reads/writes:** ~50-200/day

**Conclusion:** Will stay within free tier for foreseeable future ✅

---

**Last Updated:** 2026-02-13  
**Version:** 1.0.0
